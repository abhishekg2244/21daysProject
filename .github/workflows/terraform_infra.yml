name: Terraform
on:
  workflow_dispatch:

jobs:
  terraform:
    name: Terraform Deployment
    runs-on: self-hosted

    # ðŸ”¥ This enables manual approval (via Environments)
    environment: 
      name: prod   # create an environment in GitHub UI and enable "Required reviewers"
    
    steps:

      # Step 1 â€“ Checkout the repo
      - name: Checkout
        uses: actions/checkout@v4

      # Step 2 â€“ Login to Azure
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # Step 3 â€“ Terraform Init
      - name: Terraform Init
        run: terraform init
        shell: pwsh        # since you are using Windows self-hosted runner

      # Step 4 â€“ Terraform Plan
      - name: Terraform Plan
        run: terraform plan
        shell: pwsh

      # Step 5 â€“ Terraform Apply (after manual approval)
      - name: Terraform Apply
        run: terraform apply -auto-approve
        shell: pwsh
